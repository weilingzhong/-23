<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Sonic Fireworks | Floral Edition</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { margin: 0; overflow: hidden; background-color: #050505; font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        canvas { display: block; position: absolute; top: 0; left: 0; z-index: 1; }
        
        /* 隐形交互区域 */
        #interaction-zone {
            position: absolute;
            inset: 0;
            z-index: 10;
            cursor: pointer;
        }

        /* 隐藏文件上传默认样式 */
        input[type="file"]::file-selector-button { display: none; }
        
        /* 动画 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 1s ease-out forwards;
        }
        .delay-100 { animation-delay: 0.1s; }
        .delay-200 { animation-delay: 0.2s; }
    </style>
    <script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
    "react": "https://esm.sh/react@^19.2.3",
    "@google/genai": "https://esm.sh/@google/genai@^1.33.0",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body class="text-white selection:bg-pink-500 selection:text-white antialiased">

    <!-- 交互区 -->
    <div id="interaction-zone" title="Click to bloom"></div>

    <!-- HUD (运行界面) -->
    <div id="hud" class="absolute inset-0 pointer-events-none z-20 hidden transition-all duration-700 opacity-0">
        <!-- 顶部栏 -->
        <div class="absolute top-0 left-0 w-full p-6 flex justify-between items-start">
            
            <!-- 左上角：控制区 (返回 + 音乐控制) -->
            <div class="flex items-center gap-4 pointer-events-auto">
                <!-- 返回键 -->
                <button id="back-btn" class="cursor-pointer w-10 h-10 rounded-full bg-white/5 backdrop-blur-md border border-white/10 hover:bg-white/10 hover:border-pink-400/50 transition-all flex items-center justify-center group active:scale-95 shadow-lg">
                    <i class="fas fa-arrow-left text-white/70 group-hover:text-pink-300 transition-colors text-xs"></i>
                </button>

                <!-- 音乐控制器 (Compact & Top-Left) -->
                <div id="music-controls" class="hidden flex-row gap-3 items-center bg-black/40 backdrop-blur-xl border border-white/10 px-4 py-1.5 rounded-full shadow-2xl transition-all hover:bg-black/60 hover:border-blue-400/30 group">
                    <div class="flex items-center gap-2 border-r border-white/10 pr-3">
                        <div class="w-1 h-1 rounded-full bg-gradient-to-r from-blue-400 to-pink-400 animate-pulse"></div>
                        <span id="track-name" class="text-[9px] font-bold tracking-[0.1em] max-w-[80px] truncate text-white/90">TRACK</span>
                    </div>
                    
                    <div class="flex items-center gap-3 text-white/60">
                        <button id="ctrl-replay" class="hover:text-blue-400 transition-colors"><i class="fas fa-rotate-left text-[9px]"></i></button>
                        <button id="ctrl-play" class="w-6 h-6 rounded-full bg-white/10 flex items-center justify-center hover:bg-gradient-to-r hover:from-blue-500 hover:to-pink-500 hover:text-white transition-all shadow hover:shadow-blue-500/50"><i class="fas fa-play text-[8px] ml-0.5"></i></button>
                        <button id="ctrl-pause" class="hover:text-pink-400 transition-colors"><i class="fas fa-pause text-[9px]"></i></button>
                    </div>
                </div>
            </div>

            <!-- 右上角：信息面板 -->
            <div class="flex flex-col items-end gap-2 pointer-events-auto">
                <div class="px-5 py-2 rounded-full bg-white/5 backdrop-blur-md border border-white/10 text-[10px] font-bold tracking-[0.2em] text-blue-200 uppercase shadow-lg">
                     <span id="audio-source-label">WAITING</span>
                </div>
                <div id="freq-monitor" class="text-[9px] font-mono text-white/30 tracking-widest uppercase">
                    Lily(Low):0 | Peony(Mid):0 | Star(High):0
                </div>
            </div>
        </div>
    </div>

    <!-- Start Screen (启动页) -->
    <div id="start-screen" class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-[#050505] transition-opacity duration-700">
        
        <!-- 背景氛围光 -->
        <div class="absolute inset-0 overflow-hidden pointer-events-none">
            <div class="absolute top-[-20%] left-[-10%] w-[60%] h-[60%] bg-blue-900/10 rounded-full blur-[150px] animate-pulse"></div>
            <div class="absolute bottom-[-20%] right-[-10%] w-[60%] h-[60%] bg-pink-900/10 rounded-full blur-[150px] animate-pulse" style="animation-delay: 2s;"></div>
        </div>

        <div class="relative z-10 flex flex-col items-center animate-fade-in">
            <!-- 标题 -->
            <h1 class="text-7xl md:text-8xl font-thin tracking-tighter mb-4 bg-clip-text text-transparent bg-gradient-to-br from-blue-200 via-white to-pink-200 drop-shadow-2xl">
                FLORAL
            </h1>
            <p class="text-[10px] font-medium tracking-[0.8em] text-white/30 mb-16 uppercase delay-100 animate-fade-in">
                Sonic Visualizer
            </p>

            <!-- 按钮组 -->
            <div class="flex flex-col gap-5 w-72 delay-200 animate-fade-in">
                <!-- 麦克风按钮 (高亮) -->
                <button id="start-mic-btn" class="group relative px-8 py-4 rounded-full bg-gradient-to-r from-blue-600 to-pink-600 text-white font-semibold text-xs tracking-[0.15em] shadow-[0_0_30px_rgba(59,130,246,0.3)] hover:shadow-[0_0_50px_rgba(236,72,153,0.5)] hover:scale-[1.02] transition-all duration-500 overflow-hidden cursor-pointer">
                    <div class="absolute inset-0 bg-white/20 translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700 skew-x-12"></div>
                    <div class="flex items-center justify-center gap-3 relative z-10">
                        <i class="fas fa-microphone text-white/90"></i>
                        <span>MICROPHONE</span>
                    </div>
                </button>

                <!-- 上传按钮 (次级) -->
                <div class="relative">
                     <input type="file" id="music-upload" accept="audio/*" class="hidden" />
                     <button id="upload-btn" class="w-full px-8 py-4 rounded-full bg-white/5 border border-white/5 text-white/50 font-medium text-xs tracking-[0.15em] hover:bg-white/10 hover:text-white hover:border-white/20 transition-all duration-300 cursor-pointer" onclick="document.getElementById('music-upload').click()">
                        <div class="flex items-center justify-center gap-3">
                            <i class="fas fa-music"></i>
                            <span>LOCAL FILE</span>
                        </div>
                    </button>
                </div>
            </div>

            <!-- 图例 -->
            <div class="mt-20 flex gap-8 opacity-30 text-[9px] tracking-[0.2em] uppercase delay-200 animate-fade-in font-mono">
                <div class="flex items-center gap-2">
                    <div class="w-1 h-1 rounded-full bg-pink-400 shadow-[0_0_10px_pink]"></div> 
                    <div>LILY <span class="text-[7px] text-white/60 ml-1">BASS</span></div>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-1 h-1 rounded-full bg-yellow-400 shadow-[0_0_10px_yellow]"></div> 
                    <div>PEONY <span class="text-[7px] text-white/60 ml-1">MID</span></div>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-1 h-1 rounded-full bg-blue-400 shadow-[0_0_10px_blue]"></div> 
                    <div>STAR <span class="text-[7px] text-white/60 ml-1">HIGH</span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden Media Elements -->
    <video id="video-feed" class="hidden" playsinline muted autoplay></video>
    <audio id="music-player" crossorigin="anonymous"></audio>

    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        // ==========================================
        // 1. CONFIGURATION
        // ==========================================
        const CONFIG = {
            audio: {
                fftSize: 2048,
                smoothing: 0.85,
                thresholds: {
                    bass: 170, 
                    mid: 160, 
                    high: 150 
                }
            },
            styles: {
                bass: {
                    // Lily (百合): 扇形, 低空, 对应 Bass (Low)
                    palettes: [
                        [0xFFFFFF, 0xFFE4E1, 0xFFC0CB, 0xFFB6C1], 
                        [0xFFFFFF, 0xE0FFFF, 0xAFEEEE, 0x00CED1],
                        [0xFFFFFF, 0xFFDAB9, 0xFFA07A, 0xFF7F50]
                    ],
                    baseSize: 0.15, 
                    rayCount: 80,
                    particlesPerRay: 60,
                    explosionSpeed: 0.6,
                    drag: 0.95,
                    gravity: 0.002,
                    type: 'lily'
                },
                mid: {
                    // Peony (芍药): 球形, 中层, 对应 Mid
                    palettes: [
                        [0xFFFF00, 0xFFD700, 0xE6E6FA, 0xD8BFD8],
                        [0x90EE90, 0x32CD32, 0xFFD700, 0xFAFAD2],
                        [0xFF69B4, 0xC71585, 0xFFC0CB, 0xDC143C]
                    ],
                    baseSize: 0.15, 
                    rayCount: 100,
                    particlesPerRay: 80,
                    explosionSpeed: 0.8,
                    drag: 0.94,
                    gravity: 0.003,
                    type: 'peony'
                },
                high: {
                    // Starburst: 五角星形状, 高空, 速度快, 对应 High
                    palettes: [
                        [0x4B0082, 0x8A2BE2, 0x00BFFF, 0x87CEFA],
                        [0x00FFFF, 0xFF00FF, 0xEE82EE, 0xFFFFFF],
                        [0xFF4500, 0xFF8C00, 0xFFD700, 0xFFFFE0]
                    ],
                    baseSize: 0.12,
                    rayCount: 120,
                    particlesPerRay: 40,
                    explosionSpeed: 1.2,
                    drag: 0.92,
                    gravity: 0.005,
                    type: 'starburst'
                }
            },
            maxRockets: 8, 
            worldWidth: 80
        };

        // ==========================================
        // 2. STATE MANAGEMENT
        // ==========================================
        const state = {
            isRunning: false,
            audioCtx: null,
            analyser: null,
            dataArray: null,
            sourceNode: null, 
            fileSourceNode: null,
            rockets: [],
            explosions: [],
            lastTriggerTime: 0
        };

        // ==========================================
        // 3. CORE ENGINE (Three.js)
        // ==========================================
        let scene, camera, renderer, composer, particleTexture;

        function createGlowTexture() {
            const canvas = document.createElement('canvas');
            // High Res Texture for 4K HD feel
            canvas.width = 128; canvas.height = 128;
            const ctx = canvas.getContext('2d');
            const grad = ctx.createRadialGradient(64,64,0,64,64,64);
            grad.addColorStop(0, 'rgba(255,255,255,1)'); 
            grad.addColorStop(0.1, 'rgba(255,255,255,0.6)'); 
            grad.addColorStop(0.4, 'rgba(255,255,255,0.1)');
            grad.addColorStop(1, 'rgba(255,255,255,0)');
            ctx.fillStyle = grad;
            ctx.fillRect(0,0,128,128);
            return new THREE.CanvasTexture(canvas);
        }

        function initThreeJS() {
            if (renderer) return;

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000000); 

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 5, 60);
            camera.lookAt(0, 10, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
            renderer.setSize(window.innerWidth, window.innerHeight);
            // Use full device pixel ratio for 4K sharpness
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);

            const renderPass = new RenderPass(scene, camera);
            const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
            bloomPass.threshold = 0.4;
            bloomPass.strength = 0.4; 
            bloomPass.radius = 0.8;

            composer = new EffectComposer(renderer);
            composer.addPass(renderPass);
            composer.addPass(bloomPass);

            particleTexture = createGlowTexture();

            const grid = new THREE.GridHelper(200, 50, 0x111111, 0x000000);
            grid.position.y = -20;
            scene.add(grid);

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
                composer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        // ==========================================
        // 4. PARTICLES SYSTEM
        // ==========================================
        
        class Explosion {
            constructor(pos, typeKey, palette) {
                this.isAlive = true;
                this.typeKey = typeKey;
                const config = CONFIG.styles[typeKey];
                
                // Randomize explosion size (0.7x to 1.4x)
                const bloomScale = 0.7 + Math.random() * 0.7;

                this.life = 1.0;
                this.decay = 0.015; 

                const geo = new THREE.BufferGeometry();
                const positions = [];
                const velocities = [];
                const colors = [];
                const sizes = [];
                const lifeOffsets = []; 

                // Use the palette passed from the rocket
                const colorList = palette || config.palettes[0];

                const getColor = () => {
                    const hex = colorList[Math.floor(Math.random() * colorList.length)];
                    return new THREE.Color(hex);
                };

                // Pre-calculate rotation for Starburst (High) so the whole star rotates together
                // Using Euler for 3D orientation of the 2D star plane
                // FIXED: Restrict to Z-axis rotation only so stars always face the camera (Frontal bloom)
                const starRotation = new THREE.Euler(
                    0, 
                    0, 
                    Math.random() * Math.PI * 2
                );
                
                for(let r = 0; r < config.rayCount; r++) {
                    const dir = new THREE.Vector3();
                    
                    if (config.type === 'lily') {
                        // Lily: Fan/Bowl shape
                        const theta = Math.random() * Math.PI * 2;
                        const phi = Math.random() * Math.PI / 2; 
                        dir.setFromSphericalCoords(1, phi, theta);
                    } else if (config.type === 'starburst') {
                        // Starburst (High): 5-Pointed Star Shape Logic
                        const segments = 10; 
                        const segment = Math.floor(Math.random() * segments);
                        const t = Math.random(); 
                        
                        // 10 segments for 5 points (Outer->Inner, Inner->Outer...)
                        const angleStep = Math.PI * 2 / segments;
                        const angleStart = segment * angleStep;
                        const angleEnd = (segment + 1) * angleStep;
                        
                        // Geometric ratio for standard star (approx 0.38 for inner radius)
                        const rOuter = 1.0;
                        const rInner = 0.38; 
                        
                        // Even segments start at Outer, Odd start at Inner
                        const r1 = (segment % 2 === 0) ? rOuter : rInner;
                        const r2 = (segment % 2 === 0) ? rInner : rOuter;
                        
                        // Generate points on the perimeter of the star (XY plane)
                        // Align tip upwards by subtracting PI/2
                        const x1 = Math.cos(angleStart - Math.PI/2) * r1; 
                        const y1 = Math.sin(angleStart - Math.PI/2) * r1;
                        
                        const x2 = Math.cos(angleEnd - Math.PI/2) * r2;
                        const y2 = Math.sin(angleEnd - Math.PI/2) * r2;
                        
                        // Linear interpolation between the two points to fill the edge
                        // Do not normalize to keep the star shape (velocity proportional to distance from center)
                        dir.set(
                            x1 + (x2 - x1) * t,
                            y1 + (y2 - y1) * t,
                            (Math.random() - 0.5) * 0.1 // Slight Z depth for volume
                        );
                        
                        // Apply random 3D rotation to the entire star plane
                        dir.applyEuler(starRotation);

                    } else {
                        // Peony (Mid): Spherical (Unchanged)
                        const theta = Math.random() * Math.PI * 2;
                        const phi = Math.acos((Math.random() * 2) - 1);
                        dir.setFromSphericalCoords(1, phi, theta);
                    }

                    const rayColor = getColor();
                    
                    for(let p = 0; p < config.particlesPerRay; p++) {
                        const t = p / config.particlesPerRay; 
                        
                        positions.push(pos.x, pos.y, pos.z);
                        
                        // Apply bloomScale to speed to control explosion radius
                        // Note: for starburst, dir length varies, so speed varies naturally to form shape
                        const speed = config.explosionSpeed * (0.1 + t * 0.9) * bloomScale; 
                        const speedJitter = 1.0 + (Math.random() - 0.5) * 0.1;
                        
                        velocities.push(
                            dir.x * speed * speedJitter, 
                            dir.y * speed * speedJitter, 
                            dir.z * speed * speedJitter
                        );

                        const c = rayColor.clone();
                        if (Math.random() > 0.85) c.lerp(new THREE.Color(0xFFFFFF), 0.3);
                        colors.push(c.r, c.g, c.b);

                        const sizeMult = 1.0 - (t * 0.5); 
                        sizes.push(config.baseSize * sizeMult);
                        
                        lifeOffsets.push(t);
                    }
                }

                geo.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
                geo.setAttribute('velocity', new THREE.Float32BufferAttribute(velocities, 3));
                geo.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
                geo.setAttribute('size', new THREE.Float32BufferAttribute(sizes, 1));
                geo.setAttribute('lifeOffset', new THREE.Float32BufferAttribute(lifeOffsets, 1));

                this.material = new THREE.PointsMaterial({
                    size: 1.0, 
                    map: particleTexture,
                    vertexColors: true,
                    blending: THREE.AdditiveBlending,
                    depthWrite: false,
                    transparent: true,
                    opacity: 1,
                    sizeAttenuation: true 
                });

                this.mesh = new THREE.Points(geo, this.material);
                scene.add(this.mesh);
            }

            update() {
                this.life -= this.decay;
                const config = CONFIG.styles[this.typeKey];
                
                const positions = this.mesh.geometry.attributes.position.array;
                const velocities = this.mesh.geometry.attributes.velocity.array;
                const lifeOffsets = this.mesh.geometry.attributes.lifeOffset.array;
                const sizes = this.mesh.geometry.attributes.size.array;

                const count = positions.length / 3;

                for(let i=0; i<count; i++) {
                    const idx3 = i * 3;
                    
                    positions[idx3]     += velocities[idx3];
                    positions[idx3 + 1] += velocities[idx3 + 1];
                    positions[idx3 + 2] += velocities[idx3 + 2];

                    velocities[idx3]     *= config.drag;
                    velocities[idx3 + 1] *= config.drag;
                    velocities[idx3 + 2] *= config.drag;

                    velocities[idx3 + 1] -= config.gravity;
                    
                    if (this.life < 0.8) {
                        sizes[i] *= 0.98; 
                    }
                }

                this.mesh.geometry.attributes.position.needsUpdate = true;
                this.mesh.geometry.attributes.size.needsUpdate = true;

                this.material.opacity = Math.max(0, this.life);

                if(this.life <= 0) {
                    this.isAlive = false;
                    scene.remove(this.mesh);
                    this.mesh.geometry.dispose();
                }
            }
        }

        class Rocket {
            constructor(startX, typeKey) {
                this.isAlive = true;
                this.typeKey = typeKey;
                
                let minH, maxH;
                if (typeKey === 'bass') {
                    minH = -2; maxH = 8;
                } else if (typeKey === 'mid') {
                    minH = 8; maxH = 18;
                } else {
                    minH = 18; maxH = 32;
                }
                
                this.targetY = minH + Math.random() * (maxH - minH);
                
                // Randomly select a palette for this specific rocket/explosion
                const styleConfig = CONFIG.styles[typeKey];
                this.palette = styleConfig.palettes[Math.floor(Math.random() * styleConfig.palettes.length)];
                
                const colorHex = this.palette[1] || 0xFFFFFF;
                
                const geometry = new THREE.CapsuleGeometry(0.08, 0.4, 4, 8); 
                const material = new THREE.MeshBasicMaterial({ color: 0xFFFFFF });
                this.mesh = new THREE.Mesh(geometry, material);
                this.mesh.position.set(startX, -15, 0);
                scene.add(this.mesh);

                const startY = -15;
                const distance = this.targetY - startY;
                const speed = distance * 0.024 * (1.0 + Math.random() * 0.1); 

                this.velocity = new THREE.Vector3(0, speed, 0);
                
                this.trailPoints = [];
                this.trailGeo = new THREE.BufferGeometry();
                this.trailMat = new THREE.LineBasicMaterial({ color: colorHex, transparent: true, opacity: 0.3 });
                this.trail = new THREE.Line(this.trailGeo, this.trailMat);
                scene.add(this.trail);
            }
            update() {
                this.mesh.position.add(this.velocity);
                this.velocity.y *= 0.98; 
                this.trailPoints.push(this.mesh.position.clone());
                if(this.trailPoints.length > 15) this.trailPoints.shift();
                this.trailGeo.setFromPoints(this.trailPoints);

                if (this.mesh.position.y >= this.targetY || this.velocity.y < 0.05) {
                    this.isAlive = false;
                    scene.remove(this.mesh);
                    scene.remove(this.trail);
                    state.explosions.push(new Explosion(this.mesh.position, this.typeKey, this.palette));
                }
            }
        }

        // ==========================================
        // 5. LOGIC & INTERACTION
        // ==========================================

        function launchRocket(typeKey) {
            if (state.rockets.length > CONFIG.maxRockets) return;
            const xPos = (Math.random() - 0.5) * CONFIG.worldWidth * 0.8;
            state.rockets.push(new Rocket(xPos, typeKey));
        }

        const interactionZone = document.getElementById('interaction-zone');
        interactionZone.addEventListener('mousedown', (e) => {
            if(!state.isRunning) return;
            if (state.audioCtx && state.audioCtx.state === 'suspended') {
                state.audioCtx.resume();
            }
            const types = ['bass', 'mid', 'high'];
            const randomType = types[Math.floor(Math.random() * types.length)];
            launchRocket(randomType);
        });

        function analyzeAudio() {
            if (!state.analyser) return;
            state.analyser.getByteFrequencyData(state.dataArray);
            const getAvg = (start, end) => {
                let sum = 0;
                for(let i=start; i<end; i++) sum += state.dataArray[i];
                return sum / (end - start);
            };
            const bassVol = getAvg(0, 8);      
            const midVol = getAvg(20, 100);    
            const highVol = getAvg(150, 600);  

            // UPDATE HUD: Added (LOW/MID/HIGH) labels
            document.getElementById('freq-monitor').innerHTML = 
                `<span class="text-pink-300">LILY(LOW):${bassVol.toFixed(0)}</span> | ` +
                `<span class="text-yellow-300">PEONY(MID):${midVol.toFixed(0)}</span> | ` +
                `<span class="text-blue-300">STAR(HIGH):${highVol.toFixed(0)}</span>`;

            const now = Date.now();
            if (now - state.lastTriggerTime > 150) { 
                if (highVol > CONFIG.audio.thresholds.high) {
                    launchRocket('high');
                    state.lastTriggerTime = now;
                } else if (midVol > CONFIG.audio.thresholds.mid) {
                    launchRocket('mid');
                    state.lastTriggerTime = now;
                } else if (bassVol > CONFIG.audio.thresholds.bass) {
                    launchRocket('bass');
                    state.lastTriggerTime = now;
                }
            }
        }

        function loop() {
            if (!state.isRunning) return;
            requestAnimationFrame(loop);
            if (state.analyser) analyzeAudio();
            state.rockets.forEach(r => r.update());
            state.explosions.forEach(e => e.update());
            state.rockets = state.rockets.filter(r => r.isAlive);
            state.explosions = state.explosions.filter(e => e.isAlive);
            composer.render();
        }

        // ==========================================
        // 6. SETUP
        // ==========================================

        function transitionToHud(sourceName) {
            const startScreen = document.getElementById('start-screen');
            const hud = document.getElementById('hud');
            
            startScreen.style.opacity = '0';
            setTimeout(() => {
                startScreen.classList.add('hidden');
                hud.classList.remove('hidden');
                void hud.offsetWidth; 
                hud.style.opacity = '1';
                document.getElementById('audio-source-label').innerText = sourceName;
                initThreeJS();
                state.isRunning = true;
                loop();
            }, 700);
        }

        // MIC
        document.getElementById('start-mic-btn').addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                // If there's an old context from file mode, reuse or close it? 
                // We'll close and recreate to be safe for MIC/FILE separation
                if (state.audioCtx) state.audioCtx.close();
                
                state.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                state.analyser = state.audioCtx.createAnalyser();
                state.analyser.fftSize = CONFIG.audio.fftSize;
                state.analyser.smoothingTimeConstant = CONFIG.audio.smoothing;
                state.sourceNode = state.audioCtx.createMediaStreamSource(stream);
                state.sourceNode.connect(state.analyser);
                state.dataArray = new Uint8Array(state.analyser.frequencyBinCount);
                // Mic doesn't connect to destination to avoid feedback
                
                transitionToHud('LIVE MIC');
            } catch(e) {
                alert("Microphone access denied: " + e.message);
            }
        });

        // FILE
        document.getElementById('music-upload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(!file) return;
            
            const player = document.getElementById('music-player');
            const url = URL.createObjectURL(file);
            player.src = url;
            
            document.getElementById('track-name').innerText = file.name.substring(0, 15).toUpperCase();
            document.getElementById('music-controls').classList.remove('hidden');
            document.getElementById('music-controls').classList.add('flex');

            // --- FIXED LOGIC START ---
            if (!state.audioCtx) {
                state.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (state.audioCtx.state === 'suspended') {
                state.audioCtx.resume();
            }

            if (!state.analyser) {
                state.analyser = state.audioCtx.createAnalyser();
                state.analyser.fftSize = CONFIG.audio.fftSize;
                state.analyser.smoothingTimeConstant = CONFIG.audio.smoothing;
                state.dataArray = new Uint8Array(state.analyser.frequencyBinCount);
                // Connect to speakers for file playback
                state.analyser.connect(state.audioCtx.destination);
            }
            
            // Re-use source node if already created for the element (prevent InvalidStateError)
            if (!state.fileSourceNode) {
                 try {
                     state.fileSourceNode = state.audioCtx.createMediaElementSource(player);
                     state.fileSourceNode.connect(state.analyser);
                 } catch (err) {
                     console.warn("Source attach error:", err);
                 }
            }
            // --- FIXED LOGIC END ---

            player.play().then(() => {
                transitionToHud('FILE');
            }).catch(e => {
                console.warn("Autoplay blocked", e);
                transitionToHud('WAITING');
            });

            document.getElementById('ctrl-play').onclick = () => { 
                state.audioCtx.resume(); 
                player.play(); 
            };
            document.getElementById('ctrl-pause').onclick = () => player.pause();
            document.getElementById('ctrl-replay').onclick = () => { 
                player.currentTime = 0; 
                player.play(); 
            };
        });

        // Soft Reset Functionality
        document.getElementById('back-btn').addEventListener('click', () => {
             state.isRunning = false;
             
             // 1. Clean up Context
             if(state.audioCtx) {
                 state.audioCtx.close().catch(console.error);
                 state.audioCtx = null;
                 state.analyser = null;
                 state.sourceNode = null;
                 state.fileSourceNode = null; // Reset track
             }
             
             // 2. IMPORTANT: Replace audio element to clear any source bindings
             const oldPlayer = document.getElementById('music-player');
             if (oldPlayer) {
                 oldPlayer.pause();
                 oldPlayer.src = "";
                 oldPlayer.remove();
             }
             // Create fresh audio element
             const newPlayer = document.createElement('audio');
             newPlayer.id = 'music-player';
             newPlayer.crossOrigin = 'anonymous';
             document.body.appendChild(newPlayer);
             
             document.getElementById('music-upload').value = ""; 
             
             // 3. Clear Scene
             state.rockets.forEach(r => { scene.remove(r.mesh); if(r.trail) scene.remove(r.trail); });
             state.explosions.forEach(e => { scene.remove(e.mesh); e.mesh.geometry.dispose(); });
             state.rockets = [];
             state.explosions = [];
             
             const startScreen = document.getElementById('start-screen');
             const hud = document.getElementById('hud');
             
             hud.style.opacity = '0';
             
             setTimeout(() => {
                 hud.classList.add('hidden');
                 document.getElementById('music-controls').classList.add('hidden');
                 document.getElementById('music-controls').classList.remove('flex');
                 
                 startScreen.classList.remove('hidden');
                 void startScreen.offsetWidth;
                 startScreen.style.opacity = '1';
                 
                 if(renderer) {
                    renderer.clear();
                 }
             }, 700);
        });
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>